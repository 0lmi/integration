#!/bin/bash
set -e

HERE=$(dirname $(readlink -f "$0"))
INTEGRATION_PATH=$(dirname "$HERE")
export INTEGRATION_PATH

COMPOSE_CMD="docker-compose -p backend-tests \
             -f $INTEGRATION_PATH/docker-compose.yml \
             -f $INTEGRATION_PATH/docker-compose.demo.yml \
             -f $INTEGRATION_PATH/backend-tests/docker/docker-compose.backend-tests.yml"

# by default just add minio, with COMPOSE_CMD_BASE this creates the standard onprem ST setup
COMPOSE_FILES_DEFAULT=( "$INTEGRATION_PATH/docker-compose.storage.minio.yml" )
COMPOSE_FILES=()

usage() {
    echo "runner script for backend-specific integration tests"
    echo ""
    echo "./backend-tests"
    echo -e "\t-h --help"
    echo -e "\t-c --skip-cleanup \tleave containers running after tests"
    echo -e "\t-f=<FILE>         \tspecify custom compose file(s); default files will not be used,"
    echo -e "\t                  \tmake sure to specify all files you need"
}

parse_args(){
    while [ $# -gt 0 ]; do
        PARAM=`echo $1 | awk -F= '{print $1}'`
        VALUE=`echo $1 | awk -F= '{print $2}'`
        case $PARAM in
            -h | --help)
            usage
            exit
            ;;
            -c | --skip-cleanup)
            SKIP_CLEANUP=1
            ;;
            -f)
            COMPOSE_FILES+=( $VALUE )
            ;;
        esac
        shift 1
    done

    make_compose_cmd
}

make_compose_cmd () {
    if [ ${#COMPOSE_FILES[@]} -eq 0 ]
    then
        COMPOSE_FILES=$COMPOSE_FILES_DEFAULT
    fi

    for var in "${COMPOSE_FILES[@]}"
    do
        COMPOSE_CMD+=" -f ${var}"
    done
}

build_backend_tests_runner() {
    docker build -t mender-backend-tests-runner -f $INTEGRATION_PATH/backend-tests/docker/Dockerfile $INTEGRATION_PATH/backend-tests
}

run_tests() {
    $COMPOSE_CMD run mender-backend-tests-runner || failed=1
}

cleanup(){
    [ -z $SKIP_CLEANUP ] && $COMPOSE_CMD down && $COMPOSE_CMD rm || true
}

parse_args $*
build_backend_tests_runner
run_tests
cleanup

exit $failed
