#!/bin/bash

./verify-docker-versions

usage() {
    cat <<EOF
$(basename $0) [options] docker-options

--client
	Enable emulated client. To enable more than one client, you can use:
	  $(basename $0) --client scale mender-client=2

All other arguments passed to this command are passed directly to
docker-compose, if you want to run the demo, run:

'$(basename $0) up'
EOF
}

if [ "$#" -eq 0 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    usage
    exit 1
fi

CLIENT=
CLIENT_ARGS="-f docker-compose.client.yml -f docker-compose.client.demo.yml"
while [ -n "$1" ]; do
    if [ "$1" = "--no-client" ]; then
        echo "--no-client argument is deprecated. Client is now disabled by default and can be enabled with --client"
    elif [ "$1" = "--client" ]; then
        CLIENT="$CLIENT_ARGS"
        echo "-- enabling client container"
    elif [ "$1" = "--kvm" ]; then
        echo "--kvm argument is deprecated. KVM will be enabled automatically if available"
    elif [ "$1" = "down" ] || [ "$1" = "rm" ] || [ "$1" = "stop" ]; then
        # If the argument is either "down" or "rm", enable the client so that it
        # gets cleaned up, no matter if `--client` is passed or not.
        CLIENT="$CLIENT_ARGS"
        # Not a flag, so we should break out of the loop.
        break
    else
        break
    fi
    shift
done

# speed up first start by pulling containers in parallel
docker images | grep -q 'mendersoftware/deployments'

if [[ "$?" -eq 1 ]]; then
    compose_args=""
    docker_compose_output=$(docker-compose pull -h)

    # If --no-parallel option exists, it means that docker-compose is
    # running a version where --parallel is default and will warn about
    # deprecated option if used.
    #
    # This behavior was changed in version docker-compose 1.21.0
    echo "$docker_compose_output" | grep -q -- '--no-parallel'
    if [[ "$?" -eq 1 ]]; then
        compose_args = "--parallel"
    fi

    docker-compose pull ${compose_args}
fi

if [[ "$1" == "up" ]]; then
    echo "Starting Mender demo environment.."
fi

# Pass this value on to the GUI container as an env variable
export INTEGRATION_VERSION=$(git describe --tags --abbrev=0)
export MENDER_ARTIFACT_VERSION=$(extra/release_tool.py -g mender-artifact)

exec docker-compose \
     -f docker-compose.yml \
     -f docker-compose.storage.minio.yml \
     -f docker-compose.demo.yml \
     $CLIENT \
     "$@"
